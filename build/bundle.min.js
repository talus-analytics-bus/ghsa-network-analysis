"use strict";var Util={};!function(){Util.comma=d3.format(",.0f"),Util.percentize=d3.format("%"),Util.strToFloat=function(t){return"string"!=typeof t?t:parseFloat(t.replace(/[^\d\.\-]/g,""))},Util.capitalize=function(t){var e=t.split(" ");return e.map(function(t){return t.charAt(0).toUpperCase()+t.slice(1)}).join(" ")},Util.sortByKey=function(t,e,n){return t.sort(function(t,n){return t[e]<n[e]?-1:t[e]>n[e]?1:0}),n?t.reverse():t},Util.hasCommonElement=function(t,e){for(var n=e.length,a=0;a<n;a++)if(t.includes(e[a]))return!0;return!1},Util.getInputNumVal=function(t){var e=$(t),n=Util.strToFloat(e.val());return""===n?0:isNaN(n)||n<0?(e.val(0),0):(e.val(d3.format(",")(n)),n)},Util.populateSelect=function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},a=d3.selectAll(t).selectAll("option").data(e);a.exit().remove();var o=a.enter().append("option");a=o.merge(a).attr("value",function(t){return"function"==typeof n.valKey?n.valKey(t):n.valKey?t[n.valKey]:t}).text(function(t){return"function"==typeof n.nameKey?n.nameKey(t):n.nameKey?t[n.nameKey]:t}),n.selected&&("boolean"==typeof n.selected?a.attr("selected",n.selected):"function"==typeof n.selected&&a.attr("selected",function(t){var e=n.valKey?t[n.valKey]:t;return n.selected(e)}))}}();var Routing={};!function(){function t(t,e){n(t);for(var a=arguments.length,o=Array(a>2?a-2:0),r=2;r<a;r++)o[r-2]=arguments[r];e&&e.apply(void 0,o),window.scrollTo(0,0)}function e(t){crossroads.parse(t)}function n(t,e){$("#page-content").html(a[t](e))}var a={};Routing.precompileTemplates=function(){$("script[type='text/x-handlebars-template']").each(function(t,e){a[e.id.replace("-template","")]=Handlebars.compile($(e).html())})},Routing.initializeRoutes=function(){crossroads.addRoute("/",function(){t("home",App.initHome)}),crossroads.addRoute("/analysis",function(){t("analysis",App.initAnalysis,"network")}),crossroads.addRoute("/analysis/country",function(){t("analysis",App.initAnalysis,"country")}),crossroads.addRoute("/analysis/{iso}",function(e){t("analysis-country",App.initAnalysisCountry,e)}),crossroads.addRoute("/analysis/{iso}/d",function(e){t("analysis-country",App.initAnalysisCountry,e,"d")}),crossroads.addRoute("/analysis/{iso}/r",function(e){t("analysis-country",App.initAnalysisCountry,e,"r")}),crossroads.addRoute("/analysis/{iso}/{type}/table",function(e,n){t("analysis-table",App.initAnalysisTable,e,n)}),crossroads.addRoute("/analysis/{fundIso}/{recIso}",function(e,n){t("analysis-pair",App.initAnalysisPair,e,n)}),crossroads.addRoute("/submit",function(){t("submit",App.initSubmit)}),crossroads.addRoute("/glossary",function(){t("glossary")}),crossroads.addRoute("/settings",function(){t("settings",App.initSettings)}),crossroads.addRoute("/about",function(){t("about")}),hasher.prependHash="",hasher.initialized.add(e),hasher.changed.add(e),hasher.init()}}();var App={};!function(){App.initialize=function(t){App.dataStartYear=2014,App.dataEndYear=2017,App.fundColor="#053061",App.receiveColor="#67001f",App.fundColorPalette=["#053061","#2166ac","#4393c3","#92c5de","#d1e5f0"],App.receiveColorPalette=["#67001f","#b2182b","#d6604d","#f4a582","#fddbc7"],App.geoData=null,App.countries=[],App.codeToNameMap=d3.map(),App.scoresByCountry={},App.fundingData=[],App.currencies={},App.currencyIso="USD",App.fundingLookup={},App.recipientLookup={},App.capacities=[{id:"P.1",name:"P.1 - National Legislation, Policy, and Financing"},{id:"P.2",name:"P.2 - IHR Coordination, Communicaton and Advocacy"},{id:"P.3",name:"P.3 - Antimicrobial Resistance (AMR)"},{id:"P.4",name:"P.4 - Zoonotic Disease"},{id:"P.5",name:"P.5 - Food Safety"},{id:"P.6",name:"P.6 - Biosafety and Biosecurity"},{id:"P.7",name:"P.7 - Immunization"},{id:"D.1",name:"D.1 - National Laboratory System"},{id:"D.2",name:"D.2 - Real Time Surveillance"},{id:"D.3",name:"D.3 - Reporting"},{id:"D.4",name:"D.4 - Workforce Development"},{id:"R.1",name:"R.1 - Preparedness"},{id:"R.2",name:"R.2 - Emergency Response Operations"},{id:"R.3",name:"R.3 - Linking Public Health and Security Authorities"},{id:"R.4",name:"R.4 - Medical Countermeasures and Personnel Deployment"},{id:"R.5",name:"R.5 - Risk Communication"},{id:"PoE",name:"PoE - Point of Entry (PoE)"},{id:"CE",name:"CE - Chemical Events"},{id:"RE",name:"RE - Radiation Emergencies"},{id:"General IHR Implementation",name:"General IHR Implementation"}],NProgress.start(),d3.queue().defer(d3.json,"data/world.json").defer(d3.csv,"data/unsd_data.csv").defer(d3.json,"data/donor_codes.json").defer(d3.json,"data/funding_data_v13.json").defer(d3.json,"data/jee_score_data.json").defer(d3.json,"data/currencies.json").await(function(e,n,a,o,r,i,c){if(e)throw e;App.geoData=n,App.countries=n.objects.countries.geometries.map(function(t){return t.properties});var s=d3.map();a.forEach(function(t){s.set(t["ISO-alpha3 Code"],t)}),App.countries.forEach(function(t){var e=s.get(t.ISO3);t.regionName=e["Region Name"],t.subRegionName=e["Sub-region Name"],t.intermediateRegionName=e["Intermediate Region Name"],App.codeToNameMap.set(t.ISO2,t.NAME)}),App.codeToNameMap.set("General Global Benefit","General Global Benefit"),o.forEach(function(t){App.codeToNameMap.has(t.donor_code)||App.codeToNameMap.set(t.donor_code,t.donor_name)}),App.fundingData=r,App.fundingData.forEach(function(t){"General"===t.recipient_country&&(t.recipient_country="General Global Benefit",t.recipient_name="General Global Benefit")}),i.forEach(function(t){var e=t.indicator.split(" ")[0],n=e.split(".").slice(0,2).join(".");if("PoE"===n.split(".")[0]&&(n="O.1"),App.capacities.some(function(t){return t.id===n})){App.scoresByCountry[t.code]||(App.scoresByCountry[t.code]={month:t.month,year:t.year,avgScore:null,avgCapScores:[],indScores:{}});var a=App.scoresByCountry[t.code];a.indScores[n]||(a.indScores[n]=[]),a.indScores[n].push({indId:e,score:t.score})}});for(var l in App.scoresByCountry){var p=App.scoresByCountry[l];for(var d in p.indScores){var u=d3.mean(p.indScores[d],function(t){return t.score});p.avgCapScores.push({capId:d,score:u})}p.avgScore=d3.mean(p.avgCapScores,function(t){return t.score})}App.currencies=Object.assign({},c),App.currencyIso="USD",App.fundingData.forEach(function(t){var e=t.donor_code,n=t.recipient_country;App.fundingLookup[e]||(App.fundingLookup[e]=[]),App.fundingLookup[e].push(t),App.recipientLookup[n]||(App.recipientLookup[n]=[]),App.recipientLookup[n].push(t)}),t&&t(),NProgress.done()}),$(".navbar-brand span").click(function(){return hasher.setHash("")})},App.getTotalFunded=function(t){return App.fundingLookup[t]?d3.sum(App.fundingLookup[t],function(t){return t.total_spent}):0},App.getTotalReceived=function(t){return App.recipientLookup[t]?d3.sum(App.recipientLookup[t],function(t){return t.total_spent}):0},App.getCountryName=function(t){return App.codeToNameMap.has(t)?App.codeToNameMap.get(t):t},App.getFlagHtml=function(t){return'<img class="flag" src="img/flags/'+t.toLowerCase()+'.png" />'},App.getScoreNameHtml=function(t){var e="";return t>=3.5&&(e="text-success"),t<1.5&&(e="text-danger"),'<b class="'+e+'">'+App.getScoreName(t)+"</b>"},App.getScoreName=function(t){return t<1.5?"No Capacity":t<2.5?"Limited Capacity":t<3.5?"Developed Capacity":t<4.5?"Demonstrated Capacity":"Sustained Capacity"},App.siFormat=function(t){return t?d3.format(",.3s")(t).replace("G","B"):"0"},App.formatMoneyShort=function(t){var e=App.currencies[App.currencyIso].exchange_rates.find(function(t){return"USD"===t.convert_from}).multiplier,n=t*e;return n<100?Math.round(n):App.siFormat(n)},App.formatMoney=function(t){return App.formatMoneyShort(t)+" "+App.currencyIso},App.formatMoneyFull=function(t){return t<100?Math.round(t)+" "+App.currencyIso:d3.format(",.3r")(t)+" "+App.currencyIso},$.fn.DataTable.ext.pager.numbers_length=6,$.fn.dataTableExt.oSort["money-asc"]=function(t,e){var n=Util.strToFloat(t),a=Util.strToFloat(e);return n<a?-1:n>a?1:0},$.fn.dataTableExt.oSort["money-desc"]=function(t,e){var n=Util.strToFloat(t),a=Util.strToFloat(e);return n<a?1:n>a?-1:0},$.tooltipster.setDefaults({contentAsHTML:!0,trigger:"hover",offset:[5,-25],theme:"tooltipster-shadow",maxWidth:320}),$.noty.defaults.type="warning",$.noty.defaults.layout="center",$.noty.defaults.timeout=2e3}(),function(){App.initialize(function(){Routing.precompileTemplates(),Routing.initializeRoutes()})}(),function(){App.buildCategoryChart=function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},a="r"===n.moneyType?"Funder":"Recipient",o="r"===n.moneyType?App.receiveColorPalette:App.fundColorPalette;o=o.slice(0,5),e.forEach(function(t){var e=0;t.children.forEach(function(t){t.value0=e,e+=t.total_spent,t.value1=e})});var r={top:70,right:80,bottom:30,left:40},i=440,c=450,s=d3.select(t).append("svg").classed("category-chart",!0).attr("width",i+r.left+r.right).attr("height",c+r.top+r.bottom).append("g").attr("transform","translate("+r.left+", "+r.top+")"),l=d3.max(e,function(t){return t.total_spent}),p=d3.scaleLinear().domain([0,1.1*l]).range([0,i]),d=d3.scaleBand().padding(.25).domain(e.map(function(t){return t.id})).range([0,c]),u=d3.scaleOrdinal().range(o),f=d3.axisTop().ticks(5).tickFormat(App.siFormat).scale(p),m=d3.axisLeft().scale(d),h=s.selectAll(".bar-group").data(e).enter().append("g").attr("class","bar-group").attr("transform",function(t){return"translate(0, "+d(t.id)+")"});h.selectAll("rect").data(function(t){return t.children.map(function(e){return{cc:t.id,country:e}})}).enter().append("rect").attr("x",function(t){return p(t.country.value0)}).attr("width",function(t){return p(t.country.value1)-p(t.country.value0)}).attr("height",d.bandwidth()).style("fill",function(t){return u(t.country.iso)}).each(function(t){$(this).tooltipster({content:"<b>Core Capacity:</b> "+t.cc+("<br><b>"+a+":</b> "+App.getCountryName(t.country.iso))+("<br><b>Total Committed Funds:</b> "+App.formatMoney(t.country.total_committed))+("<br><b>Total Disbursed Funds:</b> "+App.formatMoney(t.country.total_spent))})}),h.append("text").attr("class","bar-label").attr("x",function(t){return p(t.total_spent)+5}).attr("y",d.bandwidth()/2).attr("dy",".35em").text(function(t){return App.formatMoney(t.total_spent)}),s.append("g").attr("class","x axis").call(f),s.append("g").attr("class","y axis").call(m),s.selectAll(".y.axis .tick text").each(function(t){var e=App.capacities.find(function(e){return e.id===t}).name;$(this).tooltipster({content:"<b>"+e+"</b>"})});var v="Total Funds Disbursed by Core Capacity";"r"===n.moneyType&&(v="Total Funds Received by Core Capacity"),s.append("text").attr("class","axis-label").attr("x",i/2).attr("y",-35).text(v)}}(),function(){App.buildCirclePack=function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},a=["#c6dbef","#084594"],o=n.colors||a,r={top:0,right:30,bottom:0,left:30},i=n.size||300,c=d3.select(t).append("svg").classed("circle-pack-chart",!0).attr("width",i+r.left+r.right).attr("height",i+r.top+r.bottom),s=c.append("g").attr("transform","translate("+r.left+", "+r.top+")"),l=c.append("defs"),p=l.append("filter").attr("id","glow");p.append("feGaussianBlur").attr("stdDeviation",3.5).attr("result","coloredBlur");var d=p.append("feMerge");d.append("feMergeNode").attr("in","coloredBlur"),d.append("feMergeNode").attr("in","SourceGraphic");var u=l.append("linearGradient").attr("id",t+"-gradient").attr("x1","0%").attr("x2","100%").attr("y1","0%").attr("y2","0%");u.append("stop").attr("stop-color",o[0]).attr("offset","0%"),u.append("stop").attr("stop-color",o[1]).attr("offset","100%");var f={name:"background",children:e.slice(0)},m=d3.pack().size([i,i]).padding(2),h=d3.hierarchy(f).sum(function(t){return t.total_spent}).sort(function(t,e){return e.total_spent-t.total_spent}),v=m(h).descendants(),y=d3.scaleLinear().range(o),g=s.selectAll("g").data(v).enter().append("g").attr("transform",function(t){return"translate("+t.x+", "+t.y+")"}).each(function(t){t.node=this}),A=g.append("g").attr("class",function(t){return t.parent?t.children?"node":"node node--leaf":"node node--root"}),b=A.append("circle").attr("r",function(t){return t.r}).filter(function(t){return t.parent}).style("fill",function(t){var e=t.data.total_spent/t.data.total_committed;return e>1&&(e=1),y(e)}).style("filter","url(#glow)").each(function(t){var e=d3.select(document.createElement("div")),n=e.append("div").attr("class","tooltip-content");n.append("div").attr("class","tooltip-title").text(t.data.NAME);var a=n.append("div").attr("class","tooltip-row-content");a.append("div").attr("class","tooltip-row").html("<b>Total Disbursed:</b> "+App.formatMoney(t.data.total_spent)),$(this).tooltipster({trigger:"hover",content:e.html()})});n.onClick&&b.on("click",function(t){return n.onClick(t.data.ISO2)})}}(),function(){App.buildNetworkMap=function(t,e){function n(t,e){var n=R.selectAll(".arc").data(t);n.exit().remove(),n.enter().append("path").attr("class","region-arc arc").each(function(){$(this).tooltipster({plugins:["follower"]})}).merge(n).each(function(t){var n='<div class="nm-tooltip-title">'+t.name+"</div>";if(t.totalFunded){var a=r("funded",e);n+="<div><b>"+a+":</b> "+(App.formatMoney(t.totalFunded)+"</div>")}if(t.totalReceived){var o=r("received",e);n+="<div><b>"+o+":</b> "+(App.formatMoney(t.totalReceived)+"</div>")}$(this).tooltipster("content",n)}).style("fill",i).attr("d",F);var a=S.selectAll(".arc").data(p);a.exit().remove(),a.enter().append("path").attr("class","subregion-arc arc").each(function(){$(this).tooltipster({plugins:["follower"]})}).merge(a).each(function(t){var n='<div class="nm-tooltip-title">'+t.name+"</div>";if(t.totalFunded){var a=r("funded",e);n+="<div><b>"+a+":</b> "+(App.formatMoney(t.totalFunded)+"</div>")}if(t.totalReceived){var o=r("received",e);n+="<div><b>"+o+":</b> "+(App.formatMoney(t.totalReceived)+"</div>")}$(this).tooltipster("content",n)}).style("fill",i).attr("d",E);var o=C.selectAll(".arc").data(d);o.exit().remove(),o=o.enter().append("path").attr("class","country-arc arc").each(function(){$(this).tooltipster({plugins:["follower"]})}).merge(o),o.on("mouseover",function(t){d3.selectAll(".link").filter(function(e){return e.donor===t.name||e.recipient===t.name}).classed("country-hover",!0)}).on("mouseout",function(){d3.selectAll(".link").classed("country-hover",!1)}).each(function(t){var n='<div class="nm-tooltip-title">'+t.name+"</div>";if(t.totalFunded){var a=r("funded",e);n+="<div><b>"+a+":</b> "+App.formatMoney(t.totalFunded)+"</div>"}if(t.totalReceived){var o=r("received",e);n+="<div><b>"+o+":</b> "+App.formatMoney(t.totalReceived)+"</div>"}$(this).tooltipster("content",n)}).style("fill",i).style("stroke","#fff").attr("d",N),c.countryClickFn&&o.on("click",function(t){return c.countryClickFn(t.iso)});var s=R.selectAll(".arc-label-path").data(t);s.exit().remove(),s.enter().append("path").attr("class","arc-label-path").merge(s).attr("id",function(t,e){return"arc-path-"+e}).attr("d",T).style("fill","none").each(function(t){var e=/(^.+?)L/,n=e.exec(d3.select(this).attr("d"))[1];n=n.replace(/,/g," ");var a=(t.theta0+t.theta1)/2;if(a>Math.PI/2&&a<3*Math.PI/2){var o=/M(.*?)A/,r=/A(.*?)0 0 1/,i=/0 0 1 (.*?)$/,c=i.exec(n)[1],s=o.exec(n)[1],l=r.exec(n)[1];n="M"+c+"A"+l+"0 0 0 "+s}d3.select(this).attr("d",n)});var l=R.selectAll(".arc-label").data(t);l.exit().remove();var u=l.enter().append("text").attr("class","arc-label");u.append("textPath").attr("startOffset","50%"),l=u.merge(l).attr("dy",function(t){var e=(t.theta0+t.theta1)/2;return e>Math.PI/2&&e<3*Math.PI/2?18:-6}),l.select("textPath").attr("xlink:href",function(t,e){return"#arc-path-"+e}).text(function(t){return t.name})}function a(t){var e=k.selectAll(".link").data(u);e.exit().remove(),e.enter().append("path").attr("class","link").each(function(){$(this).tooltipster({plugins:["follower"]})}).merge(e).attr("d",D).each(function(e){var n=App.codeToNameMap.get(e.donor),a=App.codeToNameMap.get(e.recipient),o="committed"===t?"Committed":"Disbursed",r="<b>Funder:</b> "+n+("<br><b>Recipient:</b> "+a)+("<br><b>"+o+" Funds:</b> "+App.formatMoney(e.value));$(this).tooltipster("content",r)}).transition().style("fill",M(0))}function o(t){p=[],d=[],u=[],f.empty();var e=d3.sum(t,function(t){return t.totalFlow}),n=0;t.forEach(function(t){var a=2*Math.PI*t.totalFlow/e-2*v;n+=v,t.theta0=n;var o=(t.children.length-1)*y;t.children.forEach(function(e,r){p.push(e);var i=(a-o)*(e.totalFlow/t.totalFlow);r>0&&(n+=y),e.theta0=n,e.children.forEach(function(t){f.set(t.iso,t),d.push(t),u=u.concat(t.funds);var a=i*(t.totalFlow/e.totalFlow);t.theta0=n,n+=a,t.theta1=n,t.runningTheta=t.theta0}),e.theta1=n}),t.theta1=n,n+=v}),t.forEach(function(t){t.children.forEach(function(t){t.children.forEach(function(t){t.funds.forEach(function(e){var n=(t.theta1-t.theta0)*(e.value/t.totalFlow);n<0&&(n=0),e.source={startAngle:t.runningTheta,endAngle:t.runningTheta+n},t.runningTheta+=n;var a=f.get(e.recipient);console.log(e.recipient);var o=(a.theta1-a.theta0)*(e.value/a.totalFlow);o<0&&(o=0),e.target={startAngle:a.runningTheta,endAngle:a.runningTheta+o},a.runningTheta+=o})})})})}function r(t,e){return"committed"===e?"funded"===t?"Funds Committed to Disburse":"Committed Funds to Receive":"funded"===t?"Disbursed Funds":"Received Funds"}function i(t){var e=t.totalFunded,n=t.totalReceived;return M(n/(n+e))}var c=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};console.log("initData"),console.log(e);var s=App.fundColor,l=App.receiveColor,p=[],d=[],u=[],f=d3.map(),m={top:60,right:60,bottom:120,left:60},h=c.radius||300,v=.02,y=.01,g=d3.select(t).append("svg").classed("network-map-chart",!0).attr("width",2*h+m.left+m.right).attr("height",2*h+m.top+m.bottom),A=g.append("g").attr("transform","translate("+(h+m.left)+", "+(h+m.top)+")"),b=g.append("defs"),x=b.append("linearGradient").attr("id","fund-gradient");x.append("stop").attr("stop-color",s).attr("offset","0%"),x.append("stop").attr("stop-color",l).attr("offset","100%");var _=b.append("clipPath").attr("id","circle-clip");_.append("circle").attr("r",h),A.append("rect").attr("class","overlay").attr("transform","translate("+(-h-m.left)+", "+(-h-m.top)+")").attr("width",2*h+m.left+m.right).attr("height",2*h+m.top+m.bottom);var k=A.append("g").attr("class","link-g").attr("clip-path","url(#circle-clip)"),w=A.append("g"),C=w.append("g"),S=w.append("g"),R=w.append("g"),M=d3.scaleLinear().range([s,l]),F=d3.arc().innerRadius(h+28).outerRadius(h+28+12).startAngle(function(t){return t.theta0}).endAngle(function(t){return t.theta1}),E=d3.arc().innerRadius(h+14).outerRadius(h+14+12).startAngle(function(t){return t.theta0}).endAngle(function(t){return t.theta1}),N=d3.arc().innerRadius(h).outerRadius(h+12).startAngle(function(t){return t.theta0}).endAngle(function(t){return t.theta1}),T=d3.arc().innerRadius(h+28).outerRadius(h+28+12).startAngle(function(t){return t.theta1-t.theta0>1?t.theta0:t.theta0-1}).endAngle(function(t){return t.theta1-t.theta0>1?t.theta1:t.theta1+1}),D=d3.ribbon().source(function(t){return t.source}).target(function(t){return t.target}).radius(h),P=450,I=14,O=A.append("g").attr("transform","translate("+-P/2+", "+(h+80)+")");return O.append("rect").attr("width",P).attr("height",I).style("fill","url(#fund-gradient)"),O.append("text").attr("class","legend-label").attr("y",I+12).attr("dy",".35em").style("text-anchor","start").text("Funds More"),O.append("text").attr("class","legend-label").attr("x",P).attr("y",I+12).attr("dy",".35em").style("text-anchor","end").text("Receives More"),A.update=function(t,e){o(t),n(t,e),a(e)},A.update(e),A}}(),function(){App.drawProgressCircles=function(t,e,n){function a(t){return function(e){var n=d3.interpolate(e.endAngle,t);return function(t){return e.endAngle=n(t),m(e)}}}var o=2*Math.PI,r=e.total_spent/e.total_committed;e.total_committed||(r=0);var i={top:0,right:10,bottom:0,left:10},c=55,s=35,l=d3.select(t).append("svg").classed("progress-circle-chart",!0).attr("width",2*c+i.left+i.right).attr("height",2*c+i.top+i.bottom),p=l.append("g").attr("transform","translate("+(c+i.left)+", "+(c+i.top)+")"),d=l.append("defs"),u=d.append("filter").attr("id","glow");u.append("feGaussianBlur").attr("stdDeviation",3.5).attr("result","coloredBlur");var f=u.append("feMerge");f.append("feMergeNode").attr("in","coloredBlur"),f.append("feMergeNode").attr("in","SourceGraphic");var m=d3.arc().innerRadius(s).outerRadius(c).startAngle(0);p.append("path").datum({endAngle:o}).style("fill","#ccc").attr("d",m);var h=p.append("path").datum({endAngle:0}).style("fill",n).attr("d",m);return p.append("text").attr("class","progress-circle-value").attr("dy",".35em").text(e.total_committed?d3.format(".0%")(r):"N/A"),h.transition().duration(1e3).attrTween("d",a(r*o)),p}}(),function(){App.buildTimeChart=function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},a={top:30,right:150,bottom:35,left:60},o=480,r=90,i=d3.color(n.color||"steelblue"),c=n.lightColor||i.brighter(2),s=d3.select(t).append("svg").classed("time-chart",!0).attr("width",o+a.left+a.right).attr("height",r+a.top+a.bottom).append("g").attr("transform","translate("+a.left+", "+a.top+")"),l=d3.scaleBand().padding(.2).domain(e.map(function(t){return t.year})).range([0,o]),p=d3.max(e,function(t){return d3.max([t.total_spent,t.total_committed])}),d=d3.scaleLinear().domain([0,1.2*p]).range([r,0]),u=d3.axisBottom().scale(l),f=d3.axisLeft().ticks(4).tickFormat(App.siFormat).scale(d),m=l.bandwidth();s.append("g").attr("class","x axis").attr("transform","translate(0, "+r+")").call(u),s.append("g").attr("class","y axis").call(f);var h=s.selectAll(".bar-group").data(e).enter().append("g").attr("transform",function(t){return"translate("+l(t.year)+", 0)"});h.append("rect").attr("class","bar").attr("y",function(t){return d(t.total_committed)}).attr("width",m/2).attr("height",function(t){return r-d(t.total_committed)}).style("fill",c),h.append("text").attr("class","bar-text").attr("x",m/4).attr("y",function(t){return d(t.total_committed)-8}).attr("dy",".35em").text(function(t){return App.formatMoneyShort(t.total_committed)}),h.append("rect").attr("class","bar").attr("x",m/2).attr("y",function(t){return d(t.total_spent)}).attr("width",m/2).attr("height",function(t){return r-d(t.total_spent)}).style("fill",i),h.append("text").attr("class","bar-text").attr("x",3*m/4).attr("y",function(t){return d(t.total_spent)-8}).attr("dy",".35em").text(function(t){return App.formatMoneyShort(t.total_spent)}),s.append("text").attr("class","chart-label").attr("x",o/2).attr("y",r+35).text("Year"),s.append("text").attr("class","chart-label").attr("x",-48).attr("y",-12).style("text-anchor","start").text("Amount (in USD)");var v=12,y=s.append("g").attr("transform","translate("+(o+25)+", 5)"),g=y.selectAll("g").data([c,i]).enter().append("g").attr("transform",function(t,e){return"translate(0, "+44*e+")"});return g.append("rect").attr("width",v).attr("height",30).style("fill",function(t){return t}),g.append("text").attr("class","legend-label").attr("x",v+8).attr("y",11).text(function(t,e){return 0===e?"Committed":"Disbursed"}),g.append("text").attr("class","legend-label").attr("x",v+8).attr("y",27).text(function(t,e){return"r"===n.moneyType?0===e?"Funds to Receive":"Funds Received":"Funds"}),s}}(),function(){App.drawValueSquares=function(t,e,n){for(var a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},o={top:0,right:0,bottom:0,left:0},r=5,i=5,c=10,s=10,l=100,p=20,d=(c+r)*p-r,u=(s+i)*(l/p)-i,f=d3.select(t).append("svg").attr("width",d+o.left+o.right).attr("height",u+o.top+o.bottom).append("g").attr("transform","translate("+o.left+", "+o.top+")"),m=0;m<l;m++){var h=m+1<=Math.ceil(l*e),v=(c+r)*(m%p);a.right&&(v=d-v),f.append("rect").attr("x",v).attr("y",(s+i)*Math.floor(m/p)).attr("width",c).attr("height",s).style("fill",h?n:"#ccc")}return f}}(),function(){App.populateCcDropdown=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n={id:"",name:"None - No core capacity tagged"},a=App.capacities.concat(n);Util.populateSelect(t,a,{valKey:"id",nameKey:"name",selected:!0}),$(t).multiselect({maxHeight:260,includeSelectAllOption:!0,numberDisplayed:0,dropRight:e.dropRight||!1})},App.passesCategoryFilter=function(t,e){if(!t.length&&e.includes(""))return!0;for(var n=0;n<t.length;n++)if(e.includes(t[n]))return!0;return!1}}();var Map={};!function(){Map.createWorldMap=function(t,e){function n(){f.style("stroke-width",1.5/d3.event.transform.k+"px"),f.attr("transform",d3.event.transform)}function a(t){$(this.parentNode).append(this);var e=p.bounds(t),n=e[1][0]-e[0][0],a=e[1][1]-e[0][1],o=(e[0][0]+e[1][0])/2,r=(e[0][1]+e[1][1])/2,s=Math.max(1,Math.min(8,.7/Math.max(n/i,a/c))),l=[i/2-s*o,c/2-s*r-90];return u.transition().duration(750).call(d.transform,d3.zoomIdentity.translate(l[0],l[1]).scale(s))}function o(){u.transition().duration(750).call(d.transform,d3.zoomIdentity)}function r(){d3.event.defaultPrevented&&d3.event.stopPropagation()}var i=1200,c=640,s=170,l=d3.geoMercator().translate([i/2,c/2]).scale(s).precision(.1),p=d3.geoPath().projection(l),d=d3.zoom().scaleExtent([1,8]).on("zoom",n),u=d3.selectAll(t).append("svg").classed("map",!0).attr("preserveAspectRatio","xMinYMin meet").attr("viewBox","0 0 "+i+" "+c).append("g").on("click",r,!0);u.append("rect").attr("class","overlay").attr("width",i).attr("height",c);var f=u.append("g"),m=f.append("g").attr("class","countries");f.append("g").attr("class","links"),u.call(d);var h=topojson.feature(e,e.objects.countries).features;return m.selectAll(".country").data(h).enter().append("path").attr("class","country").attr("d",p),m.append("path").datum(topojson.mesh(e,e.objects.countries,function(t,e){return t!==e})).attr("class","boundary").attr("d",p),{element:u,projection:l,path:p,zoomTo:a,reset:o}}}(),function(){App.initCountrySearchBar=function(t,e){function n(n){if(""===n.trim())return void u.hide();if(l=-1,a(),s=m.search(n),s.forEach(function(t){var e=t.item.POP2005?Math.log10(t.item.POP2005):0;t.score-=.02*e}),Util.sortByKey(s,"score"),u.show(),0===s.length)u.find(".live-search-no-results-text").show(),u.find(".live-search-results-contents").hide();else{u.find(".live-search-no-results-text").hide(),u.find(".live-search-results-contents").show();var o=d3.select(u[0]).select(".live-search-results-contents").selectAll(".live-search-results-box").data(s.slice(0,c));o.exit().remove();var r=o.enter().append("div").attr("class","live-search-results-box");r.append("div").attr("class","live-search-results-title"),r.append("div").attr("class","live-search-results-subtitle"),o=o.merge(r).on("mousedown",function(n){$(t).val(""),e(n.item)}),o.select(".live-search-results-title").text(function(t){return t.item.POP2005?t.item.NAME+" ("+t.item.ISO2+")":t.item.NAME}),o.select(".live-search-results-subtitle").style("display",function(t){return t.item.POP2005?"block":"none"}).html(function(t){return"Population: "+Util.comma(t.item.POP2005)})}}function a(){if(u.find(".live-search-results-box").removeClass("active"),l>-1){var t=l+1;u.find(".live-search-results-box:nth-child("+t+")").addClass("active")}}function o(){clearTimeout(i),u.hide()}var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},i=void 0,c=3,s=[],l=-1,p=$(t),d=p.find("input"),u=p.find(".live-search-results-container");r.topLayout?u.addClass("top-layout"):u.addClass("bottom-layout"),d.on("focus",function(){n($(this).val())}).on("blur",o).on("keyup",function(r){clearTimeout(i);var p=$(this).val();13===r.which?l>=0?($(t).val(""),o(),e(s[l])):n(p):27===r.which?o():40===r.which?l<c-1&&(l++,a()):38===r.which?l>-1&&(l--,a()):i=setTimeout(function(){n(p)},250)});var f=App.countries.slice(0);r.includeNonCountries&&App.codeToNameMap.entries().forEach(function(t){App.countries.find(function(e){return e.ISO2===t.key})||f.push({ISO2:t.key,ISO3:t.key,NAME:t.value})});var m=new Fuse(f,{shouldSort:!0,threshold:.5,distance:100,includeScore:!0,keys:["ISO2","ISO3","NAME"]})}}(),function(){function t(t,e){var n=d3.selectAll(".slider").append("div").attr("class","slider-tick-box");n.selectAll(".slider-tick-vert").data(e).enter().append("div").attr("class","slider-tick-vert").style("left",function(t,n){return 100*n/(e.length-1)+"%"});var a=n.selectAll(".slider-tick-text-container").data(e).enter().append("div").attr("class","slider-tick-text-container").style("left",function(t,n){return 100*(2*n+1)/(2*(e.length-1))+"%"});a.append("div").attr("class","slider-tick-text").text(function(t,n){return n===e.length-1?"":t})}App.initSlider=function(e,n){var a=$(e).slider(n);return t(e,d3.range(n.min,n.max+1)),a}}(),function(){App.initAnalysis=function(t){function e(){n(),a(),"network"===t?(o(),r(),i(),f(),b=d()):"country"===t&&(c(),s(".donor-table",".recipient-table"))}function n(){$(".analysis-global-tab-container .btn").on("click",function(){y=$(this).attr("tab"),"network"===y?hasher.setHash("analysis"):hasher.setHash("analysis/"+y)})}function a(){$('.analysis-global-tab-container .btn[tab="'+y+'"]').addClass("active").siblings().removeClass("active"),$('.global-tab-content-container .tab-content[tab="'+y+'"]').slideDown().siblings().slideUp()}function o(){App.populateCcDropdown(".cc-select"),$(".cc-select").on("change",u),$(".network-map-options .radio-option").click(function(){var t=$(this);t.find("input").prop("checked",!0),t.siblings().find("input").prop("checked",!1),u()}),$(".committed-info-img").tooltipster({content:"The <b>amount committed</b> refers to the amount of money committed."}),$(".disbursed-info-img").tooltipster({content:"The <b>amount disbursed</b> refers to the amount of money the recipient country has received."})}function r(){var t=App.initSlider(".time-slider",{min:App.dataStartYear,max:App.dataEndYear+1,value:[g,A],tooltip:"hide"});return t.on("change",function(t){var e=t.target.value.split(",");+e[0]===g&&+e[1]===A||(g=+e[0],A=+e[1],u())}),t}function i(){App.initCountrySearchBar(".network-country-search",function(t){v(t.ISO2)},{includeNonCountries:!0})}function c(){App.initCountrySearchBar(".table-country-search",function(t){hasher.setHash("analysis/"+t.ISO2)},{width:400,includeNonCountries:!0})}function s(t,e){var n=10,a=App.fundColorPalette,o=App.receiveColorPalette,r=[];for(var i in App.fundingLookup)"Not reported"!==i&&r.push({iso:i,name:App.codeToNameMap.get(i),total_committed:d3.sum(App.fundingLookup[i],function(t){return t.total_committed}),total_spent:d3.sum(App.fundingLookup[i],function(t){return t.total_spent})});Util.sortByKey(r,"total_spent",!0);var c=[];for(var s in App.recipientLookup)"Not reported"!==s&&c.push({iso:s,name:App.codeToNameMap.get(s),total_committed:d3.sum(App.recipientLookup[s],function(t){return t.total_committed}),total_spent:d3.sum(App.recipientLookup[s],function(t){return t.total_spent})});Util.sortByKey(c,"total_spent",!0);var l=d3.select(t).select("tbody").selectAll("tr").data(r.slice(0,n)).enter().append("tr").style("background-color",function(t,e){return a[Math.floor(e/2)]}).style("color",function(t,e){return e<4?"#fff":"black"}).on("click",function(t){"Not reported"!==t.iso&&hasher.setHash("analysis/"+t.iso)});l.append("td").html(function(t){var e=App.countries.find(function(e){return e.ISO2===t.iso}),n=e?App.getFlagHtml(t.iso):"",a=App.codeToNameMap.get(t.iso);return'<div class="flag-container">'+n+"</div>"+('<div class="name-container">'+a+"</div>")}),l.append("td").text(function(t){return App.formatMoney(t.total_committed)}),l.append("td").text(function(t){return App.formatMoney(t.total_spent)});var p=d3.select(e).select("tbody").selectAll("tr").data(c.slice(0,n)).enter().append("tr").style("background-color",function(t,e){return o[Math.floor(e/2)]}).style("color",function(t,e){return e<4?"#fff":"black"}).on("click",function(t){"Not reported"!==t.iso&&hasher.setHash("analysis/"+t.iso)});p.append("td").html(function(t){var e=App.countries.find(function(e){return e.ISO2===t.iso}),n=e?App.getFlagHtml(t.iso):"",a=e?e.NAME:t.iso;return'<div class="flag-container">'+n+"</div>"+('<div class="name-container">'+a+"</div>")}),p.append("td").text(function(t){return App.formatMoney(t.total_committed)}),p.append("td").text(function(t){return App.formatMoney(t.total_spent);
})}function l(){var t=$(".cc-select").val(),e=$(".money-type-filter input:checked").attr("ind"),n="committed"===e?"committed_by_year":"spent_by_year";return function(e){if("Not reported"===e.recipient_country)return 0;if(!App.passesCategoryFilter(e.core_capacities,t))return 0;for(var a=0,o=g;o<A;o++)a+=e[n][o];return a}}function p(){for(var t=l(),e=[],n={},a=function(e){var a=App.countries[e],o=a.ISO2,r=App.fundingLookup[o],i=App.recipientLookup[o],c=0,s=0;if(r&&(c=d3.sum(r,function(e){return t(e)})),i&&(s=d3.sum(i,function(e){return t(e)})),c||s){var l=a.regionName,p=a.subRegionName;n[l]||(n[l]={}),n[l][p]||(n[l][p]={}),n[l][p][o]||(n[l][p][o]={totalFunded:c,totalReceived:s,fundsByC:{}}),r&&r.forEach(function(e){var a=t(e);if(a){var r=e.recipient_country;if("General Global Benefit"===r||"XK"===r)return;n[l][p][o].fundsByC[r]||(n[l][p][o].fundsByC[r]=0),n[l][p][o].fundsByC[r]+=a}})}},o=0;o<App.countries.length;o++)a(o);n["Other Funders"]={"Other Funders":{}};var r=function(e){App.countries.find(function(t){return t.ISO2===e})||(n["Other Funders"]["Other Funders"][e]={totalFunded:d3.sum(App.fundingLookup[e],function(e){return t(e)}),totalReceived:0,fundsByC:{}},App.fundingLookup[e].forEach(function(a){var o=t(a);if(o){var r=a.recipient_country;if("General Global Benefit"===r||"XK"===r)return;n["Other Funders"]["Other Funders"][e].fundsByC[r]||(n["Other Funders"]["Other Funders"][e].fundsByC[r]=0),n["Other Funders"]["Other Funders"][e].fundsByC[r]+=o}}))};for(var i in App.fundingLookup)r(i);for(var c in n){var s={name:c,children:[],totalFunded:0,totalReceived:0,totalFlow:0};for(var p in n[c]){var d={name:p,children:[],totalFunded:0,totalReceived:0,totalFlow:0};for(var u in n[c][p]){var f=[];for(var m in n[c][p][u].fundsByC)f.push({donor:u,recipient:m,value:n[c][p][u].fundsByC[m]});var h=n[c][p][u].totalFunded,v=n[c][p][u].totalReceived;d.children.push({name:App.codeToNameMap.get(u),iso:u,totalFunded:h,totalReceived:v,totalFlow:h+v,funds:f}),d.totalFunded+=h,d.totalReceived+=v,d.totalFlow+=h+v}s.children.push(d),s.totalFunded+=d.totalFunded,s.totalReceived+=d.totalReceived,s.totalFlow+=d.totalFlow}e.push(s)}return e}function d(){var t=p(),e=App.buildNetworkMap(".network-map-content",t,{countryClickFn:v});return e.select(".overlay").on("click",m),e}function u(){var t=$(".money-type-filter input:checked").attr("ind"),e=p();e.length?($(".network-map-content").show(),$(".network-map-no-content").hide()):($(".network-map-content").hide(),$(".network-map-no-content").show()),b.update(e,t),$(".network-country-info").is(":visible")&&v(x)}function f(){$(".info-close-button").click(m)}function m(){h(),$(".network-country-info").slideUp()}function h(){d3.selectAll(".country-arc").classed("active",!1),d3.selectAll(".link").classed("search-hidden",!1)}function v(t){h();var e=App.codeToNameMap.get(t),n=d3.selectAll(".country-arc").filter(function(e){return e.iso===t}).classed("active",!0);if(d3.selectAll(".link").filter(function(e){return e.donor!==t&&e.recipient!==t}).classed("search-hidden",!0),n.empty())return noty({text:"<b>There are no funding data for "+e+" in this time range."}),void h();var a=n.datum();x=t,$(".nci-title").text(e),a.totalFunded?($(".nci-donor-value").text(App.formatMoney(a.totalFunded)),$(".nci-donor-section").slideDown()):$(".nci-donor-section").slideUp(),a.totalReceived?($(".nci-recipient-value").text(App.formatMoney(a.totalReceived)),$(".nci-recipient-section").slideDown()):$(".nci-recipient-section").slideUp(),$(".nci-more-button").off("click").on("click",function(){hasher.setHash("analysis/"+a.iso)}),$(".network-country-info").slideDown()}var y=t,g=App.dataStartYear,A=App.dataEndYear+1,b=void 0,x=void 0;e()}}(),function(){App.initAnalysisCountry=function(t,e){function n(){var n=App.codeToNameMap.get(t),r=l?App.getFlagHtml(t):"";$(".analysis-country-title").html(r+" "+n+" "+r).on("click",function(){return hasher.setHash("analysis/"+t)}),$(".country-name").text(n),$(".start-year").text(App.dataStartYear),$(".end-year").text(App.dataEndYear),$(".money-type").text("d"===e?"disbursed":"received"),$(".money-type-cap").text("d"===e?"Disbursed":"Received"),$(".money-type-noun").text("d"===e?"funder":"recipient"),$(".money-type-noun-cap").text("d"===e?"Funder":"Recipient"),$(".opp-money-type-noun").text("d"===e?"recipient":"funder"),$(".opp-money-type-verb").text("d"===e?"received":"donated"),e?o():a()}function a(){var e=App.getTotalFunded(t),n=App.getTotalReceived(t);if(e>n)return void hasher.setHash("analysis/"+t+"/d");if(n>e)return void hasher.setHash("analysis/"+t+"/r");$(".country-region").text(l.regionName),$(".country-subregion").text(l.subRegionName),l.intermediateRegionName?$(".country-intermediate").text(l.intermediateRegionName):$(".country-intermediate").closest(".country-details-row").hide(),$(".country-population").text(d3.format(",")(l.POP2005)),$(".country-funded-value").text(App.formatMoney(e)),$(".country-received-value").text(App.formatMoney(n)),$(".show-donor-btn").click(function(){return hasher.setHash("analysis/"+t+"/d")}),$(".show-recipient-btn").click(function(){return hasher.setHash("analysis/"+t+"/r")});var a=0,o=0;for(var r in App.fundingLookup)if("Not reported"!==r){var i=d3.sum(App.fundingLookup[r],function(t){return t.total_spent});i>a&&(a=i)}for(var c in App.recipientLookup)if("Not reported"!==c){var s=d3.sum(App.recipientLookup[c],function(t){return t.total_spent});s>o&&(o=s)}var p=e/a,d=n/o;App.drawValueSquares(".donor-squares",p,App.fundColor,{right:!0}),App.drawValueSquares(".recipient-squares",d,App.receiveColor),$(".country-summary-content").slideDown()}function o(){$(".show-table-btn").click(function(){hasher.setHash("analysis/"+t+"/"+e+"/table")});var n=!1,a=App.getTotalFunded(t),o=App.getTotalReceived(t);"d"===e?(a||(n=!0),$(".switch-type-button").text("Switch to Recipient Profile").on("click",function(){return hasher.setHash("analysis/"+t+"/r")}),$(".country-summary-value").text(App.formatMoney(a))):"r"===e&&(o||(n=!0),$(".switch-type-button").text("Switch to Funder Profile").on("click",function(){return hasher.setHash("analysis/"+t+"/d")}),$(".country-summary-value").text(App.formatMoney(o))),n?($(".country-flow-summary, .progress-circle-section, .country-chart-container").hide(),$(".country-flow-summary-empty").slideDown(),$(".submit-data-btn").click(function(){return hasher.setHash("submit")})):(r(),i(),c(),s()),$(".country-flow-content").slideDown()}function r(){for(var n=[],a={},o=App.dataStartYear;o<=App.dataEndYear;o++)a[o]={year:o,total_committed:0,total_spent:0};p[t].forEach(function(t){for(var e=App.dataStartYear;e<=App.dataEndYear;e++)a[e].total_committed+=t.committed_by_year[e],a[e].total_spent+=t.spent_by_year[e]});for(var r in a)n.push(a[r]);App.buildTimeChart(".time-chart-container",n,{color:d,lightColor:u,moneyType:e})}function i(){$(".progress-circle-title .info-img").tooltipster({content:"The <b>percent of committed funds</b> that were disbursed is shown. However, note that not all projects with disbursals have corresponding commitments, so these figures do not take into account all known funding initiatives."});var e=["P","D","R"],n={};e.forEach(function(t){n[t]={cc:t,total_committed:0,total_spent:0}}),p[t].forEach(function(t){e.forEach(function(e){if(t.core_capacities.some(function(t){return e===t.charAt(0)})){var a=t.total_committed,o=t.total_spent;o>a&&(o=a),n[e].total_committed+=a,n[e].total_spent+=o}})}),App.drawProgressCircles(".prevent-circle-chart",n.P,d),App.drawProgressCircles(".detect-circle-chart",n.D,d),App.drawProgressCircles(".respond-circle-chart",n.R,d);var a=d3.format(".0%"),o=function(t,e){if(n[e].total_committed){var o=n[e].total_spent/n[e].total_committed;$(t).text(a(o))}else $(t).parent().text("No funds committed for this core element")};o(".prevent-value","P"),o(".detect-value","D"),o(".respond-value","R")}function c(){"d"===e?$(".circle-pack-title").text("Top Recipients of Funds (from Funder)"):$(".circle-pack-title").text("Top Funders Received From");var n="d"===e?"recipient_country":"donor_code",a=[],o={};p[t].forEach(function(t){var e=t[n];"Not reported"!==e&&(o[e]||(o[e]={iso:e,total_committed:0,total_spent:0}),o[e].total_committed+=t.total_committed,o[e].total_spent+=t.total_spent)});for(var r in o)a.push(o[r]);Util.sortByKey(a,"total_spent",!0);var i="d"===e?"Recipient":"Funder";$(".country-table thead tr td:first-child").text(i);var c=d3.select(".country-table tbody").selectAll("tr").data(a.slice(0,10)).enter().append("tr").on("click",function(n){"Not reported"!==n.iso&&("d"===e?hasher.setHash("analysis/"+t+"/"+n.iso):hasher.setHash("analysis/"+n.iso+"/"+t))});c.append("td").html(function(t){var e=App.countries.find(function(e){return e.ISO2===t.iso}),n=e?App.getFlagHtml(t.iso):"",a=t.iso;App.codeToNameMap.has(t.iso)&&(a=App.codeToNameMap.get(t.iso));var o="event.stopPropagation();hasher.setHash('analysis/"+t.iso+"')";return'<div class="flag-container">'+n+'</div><div class="name-container">'+('<span onclick="'+o+'">'+a+"</span>")+"</div>"}),c.append("td").text(function(t){return App.formatMoney(t.total_committed)}),c.append("td").text(function(t){return App.formatMoney(t.total_spent)})}function s(){var n="d"===e?"recipient_country":"donor_code",a=[],o={};p[t].forEach(function(t){var e=t[n],a=t.core_capacities;a.forEach(function(n){o[n]||(o[n]={}),o[n][e]||(o[n][e]={iso:e,total_committed:0,total_spent:0}),o[n][e].total_committed+=t.total_committed,o[n][e].total_spent+=t.total_spent})}),App.capacities.forEach(function(t){if("General IHR Implementation"!==t.id)if(o[t.id]){var e=[],n=0,r=0;for(var i in o[t.id])e.push(o[t.id][i]),n+=o[t.id][i].total_committed,r+=o[t.id][i].total_spent;a.push({id:t.id,name:t.name,children:e,total_committed:n,total_spent:r})}else a.push({id:t.id,name:t.name,children:[],total_committed:0,total_spent:0})}),Util.sortByKey(a,"total_spent",!0),App.buildCategoryChart(".category-chart-container",a,{moneyType:e})}var l=App.countries.find(function(e){return e.ISO2===t}),p="d"===e?App.fundingLookup:App.recipientLookup,d="d"===e?App.fundColor:App.receiveColor,u="d"===e?App.fundColorPalette[4]:App.receiveColorPalette[4];n()}}(),function(){var t=void 0,e=!1,n="all";App.initAnalysisPair=function(a,o){function r(){var t=p?App.getFlagHtml(a):"",e=d?App.getFlagHtml(o):"",r="hasher.setHash('analysis/"+a+"')",s="hasher.setHash('analysis/"+o+"')",h='<span onclick="'+r+'">'+u+"</span>",v='<span onclick="'+s+'">'+f+"</span>";l.find(".analysis-country-title").html(t+" "+h+" "+('<div class="arrow-html">&rarr;</div> '+v+" "+e)),$(".start-year").text(App.dataStartYear),$(".end-year").text(App.dataEndYear);var y=d3.sum(m,function(t){return t.total_committed}),g=d3.sum(m,function(t){return t.total_spent});$(".committed-value").text(App.formatMoney(y)),$(".spent-value").text(App.formatMoney(g)),$(".donor-button").click(function(){return hasher.setHash("analysis/"+a+"/d")}),$(".recipient-button").click(function(){return hasher.setHash("analysis/"+o+"/r")}),l.find(".funds-tab-container .btn").on("click",function(){n=$(this).attr("tab"),i(),c()}),i(),c()}function i(){l.find('.funds-tab-container .btn[tab="'+n+'"]').addClass("active").siblings().removeClass("active")}function c(){var a=[];"all"===n?a=[{name:"Funder",value:"donor_name"},{name:"Recipient",value:"recipient_name"},{name:"Name",value:"project_name"},{name:"Committed",value:"total_committed",type:"money"},{name:"Disbursed",value:"total_spent",type:"money"}]:"cc"===n&&(a=[{name:"Core Capacity",value:function(t){var e=App.capacities.find(function(e){return e.id===t.cc});return e?e.name:""}},{name:"Committed",value:"total_committed",type:"money"},{name:"Disbursed",value:"total_spent",type:"money"}]);var o=[];if("all"===n)o=m.slice(0);else if("cc"===n){var r={};m.forEach(function(t){t.core_capacities.forEach(function(e){r[e]||(r[e]={total_committed:0,total_spent:0}),r[e].total_committed+=t.total_committed,r[e].total_spent+=t.total_spent})});for(var i in r)o.push({cc:i,total_committed:r[i].total_committed,total_spent:r[i].total_spent})}e&&t.destroy();var c=s.select(".funds-table"),p=c.select("thead tr"),d=p.selectAll("th").data(a);d.exit().remove(),d.enter().append("th").merge(d).classed("money-cell",function(t){return"money"===t.type}).text(function(t){return t.name});var u=c.select("tbody"),f=u.selectAll("tr").data(o);f.exit().remove();var h=f.enter().append("tr"),v=h.merge(f).selectAll("td").data(function(t){return a.map(function(e){return{rowData:t,colData:e}})});v.exit().remove(),v.enter().append("td").merge(v).classed("money-cell",function(t){return"money"===t.colData.type}).text(function(t){var e="";return e="function"==typeof t.colData.value?t.colData.value(t.rowData):t.rowData[t.colData.value],"money"===t.colData.type?App.formatMoneyFull(e):e});var y=[],g=[];"all"===n?(y=[4,"desc"],g=[{type:"money",targets:[3,4],width:"120px"}]):"cc"===n&&(y=[2,"desc"],g=[{type:"money",targets:[1,2],width:"120px"}]),t=l.find(".funds-table").DataTable({scrollY:"30vh",scrollCollapse:!0,order:y,columnDefs:g}),e=!0}var s=d3.select(".analysis-pair-content"),l=$(".analysis-pair-content"),p=App.countries.find(function(t){return t.ISO2===a}),d=App.countries.find(function(t){return t.ISO2===o}),u=App.codeToNameMap.get(a),f=App.codeToNameMap.get(o),m=[];App.fundingLookup[a]&&(m=App.fundingLookup[a].filter(function(t){return t.recipient_country===o})),r()}}(),function(){var t=void 0,e=!1,n="all";App.initAnalysisTable=function(a,o){function r(){var t=l?App.getFlagHtml(a):"";$(".analysis-country-title").html(t+" "+p+" "+t).on("click",function(){return hasher.setHash("analysis/"+a)}),$(".money-type-noun").text("d"===o?"Funder":"Recipient"),$(".opp-money-type-noun").text("d"===o?"Recipient":"Funder"),$(".money-type-cap").text("d"===o?"Disbursed":"Received"),$(".commit-noun").text("d"===o?"Committed Funds":"Committed Funds to Receive"),$(".start-year").text(App.dataStartYear),$(".end-year").text(App.dataEndYear);var e=d3.sum(d,function(t){return t.total_committed}),n=d3.sum(d,function(t){return t.total_spent});$(".committed-value").text(App.formatMoney(e)),$(".spent-value").text(App.formatMoney(n)),$(".back-button").click(function(){return hasher.setHash("analysis/"+a+"/"+o)}),i(),c(),s()}function i(){$(".funds-tab-container .btn").on("click",function(){n=$(this).attr("tab"),c(),s()})}function c(){$('.funds-tab-container .btn[tab="'+n+'"]').addClass("active").siblings().removeClass("active")}function s(){var a=[];"all"===n?a=[{name:"Funder",value:"donor_name"},{name:"Recipient",value:"recipient_name"},{name:"Project Name",value:"project_name"},{name:"Committed",value:"total_committed",type:"money"},{name:"Disbursed",value:"total_spent",type:"money"}]:"country"===n?a=[{name:"Funder",value:function(t){return App.codeToNameMap.get(t.donor_code)}},{name:"Recipient",value:function(t){return App.codeToNameMap.has(t.recipient_country)?App.codeToNameMap.get(t.recipient_country):t.recipient_country}},{name:"Committed",value:"total_committed",type:"money"},{name:"Disbursed",value:"total_spent",type:"money"}]:"ce"===n?a=[{name:"Core Element",value:function(t){return"P"===t.ce?"Prevent":"D"===t.ce?"Detect":"R"===t.ce?"Respond":"O"===t.ce?"Other":"None"}},{name:"Committed",value:"total_committed",type:"money"},{name:"Disbursed",value:"total_spent",type:"money"}]:"cc"===n&&(a=[{name:"Core Capacity",value:function(t){var e=App.capacities.find(function(e){return e.id===t.cc});return e?e.name:t.cc}},{name:"Committed",value:"total_committed",type:"money"},{name:"Disbursed",value:"total_spent",type:"money"}]);var o=[];if("all"===n)o=d.slice(0);else if("country"===n){var r={};d.forEach(function(t){var e=t.donor_code,n=t.recipient_country;"Not reported"===n&&(n=t.recipient_name),r[e]||(r[e]={}),r[e][n]||(r[e][n]={total_committed:0,total_spent:0}),r[e][n].total_committed+=t.total_committed,r[e][n].total_spent+=t.total_spent});for(var i in r)for(var c in r[i])o.push({donor_code:i,recipient_country:c,total_committed:r[i][c].total_committed,total_spent:r[i][c].total_spent})}else if("ce"===n){var s={},l=["P","D","R","O"];l.concat("None").forEach(function(t){s[t]={total_committed:0,total_spent:0}}),d.forEach(function(t){var e=!1;l.forEach(function(n){var a=t.core_capacities.some(function(t){if("O"===n){var e=t.slice(0,3);return"PoE"===e||"CE"===e||"RE"===e}return t.slice(0,2)===n+"."});a&&(e=!0,s[n].total_committed+=t.total_committed,s[n].total_spent+=t.total_spent)}),e||(s.None.total_committed+=t.total_committed,s.None.total_spent+=t.total_spent)});for(var p in s)o.push({ce:p,total_committed:s[p].total_committed,total_spent:s[p].total_spent})}else if("cc"===n){var u={};App.capacities.concat({id:"None"}).forEach(function(t){u[t.id]={total_committed:0,total_spent:0}}),d.forEach(function(t){t.core_capacities.forEach(function(e){u[e]&&(u[e].total_committed+=t.total_committed,u[e].total_spent+=t.total_spent)}),t.core_capacities.length||(u.None.total_committed+=t.total_committed,u.None.total_spent+=t.total_spent)});for(var f in u)o.push({cc:f,total_committed:u[f].total_committed,total_spent:u[f].total_spent})}e&&t.destroy();var m=d3.select(".funds-table"),h=m.select("thead tr"),v=h.selectAll("th").data(a);v.exit().remove(),v.enter().append("th").merge(v).classed("money-cell",function(t){return"money"===t.type}).text(function(t){return t.name});var y=m.select("tbody"),g=y.selectAll("tr").data(o);g.exit().remove();var A=g.enter().append("tr");A.merge(g).on("click",function(t){hasher.setHash("analysis/"+t.donor_code+"/"+t.recipient_country)});var b=A.merge(g).selectAll("td").data(function(t){return a.map(function(e){return{rowData:t,colData:e}})});b.exit().remove(),b.enter().append("td").merge(b).classed("money-cell",function(t){return"money"===t.colData.type}).text(function(t){var e="";return e="function"==typeof t.colData.value?t.colData.value(t.rowData):t.rowData[t.colData.value],"money"===t.colData.type?App.formatMoneyFull(e):e});var x=[4,"desc"],_=[];"all"===n?_=[{targets:[0,1],width:"140px"},{type:"money",targets:[3,4],width:"110px"}]:"country"===n?(x=[3,"desc"],_=[{targets:[0,1],width:"150px"},{type:"money",targets:[2,3],width:"120px"}]):"ce"!==n&&"cc"!==n||(x=[2,"desc"],_=[{type:"money",targets:[1,2],width:"120px"}]),t=$(".funds-table").DataTable({scrollY:"40vh",scrollCollapse:!0,order:x,columnDefs:_}),e=!0}var l=App.countries.find(function(t){return t.ISO2===a}),p=App.codeToNameMap.get(a),d=[];"d"===o&&App.fundingLookup[a]&&(d=App.fundingLookup[a].slice(0)),"r"===o&&App.recipientLookup[a]&&(d=App.recipientLookup[a].slice(0)),r()}}(),function(){App.initHome=function(){function t(){A=e(),f(),p(),g(),i()}function e(){var t=Map.createWorldMap(".map-container",App.geoData);return t.element.select(".overlay").on("click",n),d3.selectAll(".country").on("click",function(e){return b.node()===this?n():(b.classed("active",!1),b=d3.select(this).classed("active",!0),t.zoomTo.call(this,e),u(),!0)}).each(function(t){$(this).tooltipster({plugins:["follower"],delay:100,minWidth:200,content:t.properties.NAME})}),$(".legend-display-tab").click(function(){var t=$(this).find(".collapse-arrow").toggleClass("rotated");$(this).find("span").text(t.hasClass("rotated")?"show legend":"hide legend"),$(".legend-content").slideToggle()}),t}function n(){A.reset(),b.classed("active",!1),b=d3.select(null),$(".info-container").slideUp()}function a(){return"score"===w?"combined"===R?"combo":"score":"funded"===C?"committed"===S?"fundedCommitted":"fundedSpent":"committed"===S?"receivedCommitted":"receivedSpent"}function o(t,e){var n="funded"===t?"Funder":"Recipient",a="";return a="committed"===e?"Committed":"funded"===t?"Disbursed":"Received","Total <b>"+a+"</b>"+("<br>from "+_+" to "+(k-1))+("<br>("+n+")")}function r(){if("score"===w&&"score"===R)return d3.scaleThreshold().domain([1.5,2,2.5,3,3.5,4,4.5]).range(E);var t=a(),e=x.values().map(function(e){return e[t]}).filter(function(t){return t});return 1===e.length&&e.push(0),d3.scaleQuantile().domain(e).range("money"===w?M:F)}function i(){c(),l(),$(".info-container").is(":visible")&&u()}function c(){var t=$(".cc-select").val();x.clear(),App.countries.forEach(function(e){var n=App.fundingLookup[e.ISO2],a=App.recipientLookup[e.ISO2],o=App.scoresByCountry[e.ISO2];if(n||a||o){var r=0,i=0,c=0,l=0,p=null,d=null;if(n){var u=s(n,t);r=u.totalCommitted,i=u.totalSpent}if(a){var f=s(a,t);c=f.totalCommitted,l=f.totalSpent}if(o){var m=o.avgCapScores.filter(function(e){return t.includes(e.capId)});p=d3.mean(m,function(t){return t.score});var h=10+Math.log10(1+l),v=5.01-p;d=h/v}x.set(e.ISO2,{fundedCommitted:r,fundedSpent:i,receivedCommitted:c,receivedSpent:l,score:p,combo:d})}})}function s(t,e){for(var n=0,a=0,o=0,r=t.length;o<r;o++){var i=t[o];if(App.passesCategoryFilter(i.core_capacities,e))for(var c=_;c<k;c++)n+=i.committed_by_year[c]||0,a+=i.spent_by_year[c]||0}return{totalCommitted:n,totalSpent:a}}function l(){var t=a(),e=r();A.element.selectAll(".country").transition().duration(500).style("fill",function(n){var a=n.properties.ISO2;return x.has(a)?(n.value=x.get(a)[t],n.color=n.value?e(n.value):"#ccc"):(n.value=null,n.color="#ccc"),n.color}).each(function(t){var e=o(C,S),n=t.value;"score"===w&&(e=o("received","disbursed"),x.has(t.properties.ISO2)&&(n=x.get(t.properties.ISO2).receivedSpent));var a=d3.select(document.createElement("div"));if(a.append("div").attr("class","tooltip-title").text(t.properties.NAME),"score"===w){var r="Avg. JEE Score: ",i=0;x.has(t.properties.ISO2)&&(i=x.get(t.properties.ISO2).score),r=i?App.getScoreNameHtml(i):"No JEE score data available",a.append("div").attr("class","tooltip-score-text").html(r)}else{var c="funded"===C?"Funder Information":"Recipient Information";a.append("div").attr("class","tooltip-profile-type").text(c)}a.append("div").attr("class","tooltip-main-value").text(App.formatMoney(n)),a.append("div").attr("class","tooltip-main-value-label").html(e),$(this).tooltipster("content",a.html())}),d(e)}function p(){var t=d3.select(".legend g");t.append("text").attr("class","legend-start-label").attr("dy",".35em"),t.append("line").attr("class","legend-start-tick legend-tick").attr("x1",1).attr("x2",1),t.append("text").attr("class","legend-title"),t.append("image").attr("class","legend-tooltip").attr("xlink:href","img/info.png").each(function(){$(this).tooltipster()})}function d(t){var e=a(),n="score"===w&&"score"===R,o=16,r=70,i=20;n&&(r=50);var c=t.range(),s="score"===w?t.domain():t.quantiles(),l=d3.max(x.values().map(function(t){return t[e]})),p=d3.select(".legend").attr("width",r*c.length+2*i).attr("height",o+50).select("g").attr("transform","translate("+i+", 0)"),d=p.selectAll("g").data(c);d.exit().remove();var u=d.enter().append("g");u.append("rect").attr("class","legend-bar").attr("height",o),u.append("text").attr("class","legend-text").attr("dy",".35em"),u.append("line").attr("class","legend-tick").attr("y1",o).attr("y2",o+4),d=d.merge(u).attr("transform",function(t,e){return"translate("+r*e+", 0)"}),d.select(".legend-bar").attr("width",r).style("fill",function(t){return t});var f=d.select(".legend-text").attr("x",r).attr("y",n?o+14:o+12);d.select(".legend-tick").attr("x1",function(t,e){return e===c.length-2?2*r-1:2*r}).attr("x2",function(t,e){return e===c.length-2?2*r-1:2*r}).style("display",function(t,e){return n&&e%2===0?"inline":"none"});var m=p.select(".legend-start-label").attr("y",o+12);p.select(".legend-start-tick").attr("y1",o).attr("y2",o+4).style("display",n?"inline":"none"),n?(f.style("text-anchor","middle").style("display",function(t,e){return e%2===0?"none":"inline"}).text(function(t,e){return(e+3)/2}),m.style("text-anchor","middle").text("1")):"score"===w&&"combined"===R?(f.style("display","inline").style("text-anchor","end").text(function(t,e){return 6===e?"Needs Met":""}),m.style("text-anchor","start").text("Needs Unmet")):(f.style("display","inline").style("text-anchor","middle").text(function(t,e){return e===s.length?App.formatMoneyShort(l):App.formatMoneyShort(s[e])}),m.style("text-anchor","start").text(0));var h="";"money"===w?(h="committed"===S?"Funds Committed":"funded"===C?"Funds Disbursed":"Funds Received",h+=" (in "+App.currencyIso+")"):"score"===w&&("score"===R?h="Average JEE Score for Selected Core Capacities":"combined"===R&&(h="Financial Resources / Needs Metric")),p.select(".legend-title").attr("x",r*c.length/2).attr("y",o+45).text(h),p.select(".legend-tooltip").attr("x",r*c.length/2+134).attr("y",o+33.5),"score"===w&&"combined"===R?$(".legend-tooltip").show().tooltipster("content","This metric combines both a country's JEE scores and the amount of disbursed funds that the country has received. We use JEE scores as a proxy for country-specific needs, and calculate the ratio of financial resources to need. The goal of this metric is to highlight areas whose needs may still be unmet based on their ratio of financial resources to need."):$(".legend-tooltip").hide(),$(".legend-container").slideDown()}function u(){var t=b.datum().properties;$(".info-title").text(t.NAME),$(".info-profile-type").css("display","money"===w?"block":"none").text("funded"===C?"Funder Information":"Recipient Information"),$(".info-analysis-button").off("click").on("click",function(){hasher.setHash("analysis/"+t.ISO2)});var e=0,n=0;if(x.has(t.ISO2)){var a=x.get(t.ISO2);if("money"===w)$(".info-score-text-container").slideUp();else if("score"===w){var r="Average JEE Score: ";r=a.score?App.getScoreNameHtml(a.score):"No JEE score data currently available",$(".info-score-text").html(r),$(".info-score-text-container").slideDown()}"money"===w&&"funded"===C?(e+=a.fundedCommitted,n+=a.fundedSpent):(e+=a.receivedCommitted,n+=a.receivedSpent)}$(".info-committed-value").text(App.formatMoney(e)),$(".info-spent-value").text(App.formatMoney(n));var i="score"===w?"received":C;$(".info-committed-value-label").html(o(i,"committed")),$(".info-spent-value-label").html(o(i,"disbursed")),$(".info-container").slideDown()}function f(){$(".map-options-title").click(function(){$(this).find(".collapse-arrow").toggleClass("rotated"),$(".map-options-content").slideToggle()}),v(),h(),m()}function m(){App.initCountrySearchBar(".search-container",function(t){var e=d3.selectAll(".country").filter(function(e){return t.ISO2===e.properties.ISO2});b.classed("active",!1),b=e.classed("active",!0),A.zoomTo.call(b.node(),b.datum()),u()})}function h(){var t=App.initSlider(".time-slider",{min:App.dataStartYear,max:App.dataEndYear+1,value:[_,k],tooltip:"hide"});return t.on("change",function(t){var e=t.target.value.split(",");+e[0]===_&&+e[1]===k||(_=+e[0],k=+e[1],i())}),t}function v(){App.populateCcDropdown(".cc-select",{dropRight:!0}),$(".ind-type-filter .radio-option").click(function(){w=$(this).find("input").attr("ind"),"money"===w?($(".score-filters").slideUp(),$(".money-filters").slideDown()):"score"===w&&($(".money-filters").slideUp(),$(".score-filters").slideDown()),y()}),$(".money-flow-type-filter .radio-option").click(function(){C=$(this).find("input").attr("ind"),y(),$('.info-tab-container .btn[tab="country"]').text("received"===C?"By Donor":"By Recipient")}),$(".money-type-filter .radio-option").click(function(){S=$(this).find("input").attr("ind"),y()}),$(".jee-score-filter .radio-option").click(function(){w="score",R=$(this).find("input").attr("ind"),y()}),$(".map-options-container select").on("change",i),$(".score-info-img").tooltipster({interactive:!0,content:"The average of each country's most recent <b>JEE scores</b>, for all JEE scores selected in the filter below."}),$(".combined-info-img").tooltipster({content:"This metric combines both a country's JEE scores and the amount of disbursed funds that the country has received. We use JEE scores as a proxy for country-specific needs, and calculate the ratio of financial resources to need. The goal of this metric is to highlight areas whose needs may still be unmet based on their ratio of financial resources to need."}),$(".map-options-container").show()}function y(){$(".ind-type-filter input").each(function(){var t=$(this);t.prop("checked",t.attr("ind")===w)}),"money"===w?($(".jee-score-filter input").prop("checked",!1),$(".money-flow-type-filter input").each(function(){var t=$(this);t.prop("checked",t.attr("ind")===C)}),$(".money-type-filter input").each(function(){var t=$(this);t.prop("checked",t.attr("ind")===S)})):"score"===w&&($(".money-type-filter input, .money-flow-type-filter input").prop("checked",!1),$(".jee-score-filter input").each(function(){var t=$(this);t.prop("checked",t.attr("ind")===R)})),i()}function g(){$(".info-close-button").on("click",n),$(".score-text-info-img").tooltipster({content:'JEE scores are taken from each country\'s <a href="http://www.who.int/ihr/procedures/mission-reports/en/" target="_blank">World Health Organization Joint External Evaluation Report</a>, when available.'})}var A=void 0,b=d3.select(null),x=d3.map(),_=App.dataStartYear,k=App.dataEndYear+1,w="money",C="received",S="disbursed",R="score",M=["#e0ecf4","#bfd3e6","#9ebcda","#8c96c6","#8c6bb1","#88419d","#810f7c","#4d004b"],F=["#fee391","#fec44f","#fe9929","#ec7014","#cc4c02","#993404","#662506"].reverse(),E=["#c91414","#ede929","#ede929","#ede929","#ede929","#0b6422","#0b6422","#0b6422"];t()}}(),function(){App.initSettings=function(){var t=Object.values(App.currencies).sort(function(t,e){return d3.ascending(t.name,e.name)});Util.populateSelect(".currency-select",t,{nameKey:function(t){return Util.capitalize(t.name)+" ("+t.iso.code+")"},valKey:function(t){return t.iso.code}}),$(".currency-select").val(App.currencyIso).on("change",function(){App.currencyIso=$(this).val()})}}(),function(){function t(t){NProgress.start();var e=new FormData;e.append("firstname",$(".first-name-input").val()),e.append("lastname",$(".last-name-input").val()),e.append("org",$(".org-input").val()),e.append("email",$(".email-input").val()),e.append("upload",t,t.name),$.ajax({url:"/upload-s3",method:"POST",data:e,processData:!1,contentType:!1}).done(function(){$(".input-report-upload").val(""),$(".file-name-text").text("No file selected"),noty({type:"success",text:"<b>Success!</b><br>Report has been submitted!"}),NProgress.done()}).fail(function(t){console.log(t.responseJSON.error),noty({text:"<b>Error!</b><br>There was an issue submitting your report. Please notify the administrators of the tool."}),NProgress.done()})}App.initSubmit=function(){$(".glossary-button").click(function(){return hasher.setHash("glossary")}),$(".btn-report-upload").click(function(){$(".input-report-upload").trigger("click")}),$(".input-report-upload").on("change",function(){var t="No file selected";this.files.length&&(t=this.files[0].name),$(".file-name-text").text(t)}),$(".submit-button").click(function(){var e=$(".first-name-input").val(),n=$(".last-name-input").val(),a=$(".org-input").val(),o=$(".email-input").val();if(!e)return void noty({text:"<b>Please enter a first name before proceeding.</b>"});if(!n)return void noty({text:"<b>Please enter a last name before proceeding.</b>"});if(!a)return void noty({text:"<b>Please enter an organization before proceeding.</b>"});if(!o)return void noty({text:"<b>Please enter an email address before proceeding.</b>"});if(!/\S+@\S+/.test(o))return void noty({text:"<b>Please enter a valid email address before proceeding.</b>"});var r=d3.select(".input-report-upload").node();if("files"in r){if(!r.files.length)return void noty({text:"<b>Please select a file before proceeding!</b>"});var i=r.files[0],c=i.name.split("."),s=c[c.length-1];if("xlsx"!==s&&"xls"!==s)return void noty({timeout:5e3,text:"<b>Please select a file with a file type extension of <i>.xls</i> or <i>.xlsx</i>"});if(i.size>1e8)return void noty({timeout:5e3,text:"<b>The file selected is too large to be uploaded!</b><br>Please select a file under 100 MB."});t(i)}})}}();